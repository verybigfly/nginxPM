FROM jc21/nginx-proxy-manager:latest
ENTRYPOINT ["/init"]
RUN apt-get update && apt-get install -y libmaxminddb0 libmaxminddb-dev && apt-get clean && rm -rf /var/lib/apt/lists/*
RUN apt-get update && apt-get install -y wget libpcre3 libpcre3-dev libssl-dev zlib1g-dev
RUN mkdir /etc/nginx/modules 
RUN ngxversion=openresty-$(/etc/nginx/bin/openresty -v 2>&1|cut -d "/" -f2) && mkdir /tmp/compile && cd /tmp/compile && wget https://openresty.org/download/$ngxversion.tar.gz && tar xvf $ngxversion.tar.gz && mkdir /tmp/compile/$ngxversion/modules && cd /tmp/compile/$ngxversion/modules && git clone https://github.com/leev/ngx_http_geoip2_module.git && cd ../bundle/nginx-$(/etc/nginx/bin/openresty -v 2>&1|cut -d "/" -f2|grep -oP '^\d*\.\d*\.\d*') && export LUAJIT_LIB="/etc/nginx/luajit/lib/" && export LUAJIT_INC="../LuaJIT-*/src/" && COMPILEOPTIONS=$(/etc/nginx/bin/openresty -V 2>&1|grep -i "arguments"|cut -d ":" -f2-) && eval ./configure $COMPILEOPTIONS --add-dynamic-module=../../modules/ngx_http_geoip2_module && make && cp -f objs/ngx_stream_geoip2_module.so /etc/nginx/modules/ && cp -f objs/ngx_http_geoip2_module.so /etc/nginx/modules/ && touch /etc/nginx/modules/ngx_geoip2_$ngxversion && apt-get clean && rm -rf /var/lib/apt/lists/* && rm -rf /tmp/compile
#RUN test -f /etc/nginx/modules/geoip2.conf && echo "let's  go" || echo -e "load_module /etc/nginx/modules/ngx_http_geoip2_module.so;\nload_module /etc/nginx/modules/ngx_stream_geoip2_module.so;" > /etc/nginx/modules/geoip2.conf
#RUN test -f /data/nginx/custom/http_top.conf && echo "let's  go" || echo -e 'charset utf-8;\ngeoip2 /data/geoip2/GeoLite2-City.mmdb {\n auto_reload 3h;\n $geoip2_metadata_country_build metadata build_epoch;\n $geoip2_data_country_code default=XX source=$remote_addr country iso_code;\n $geoip2_data_country_name default=- country names fr;\n $geoip2_data_city_name default=- city names fr;\n $geoip2_data_region_name default=- subdivisions 0 names fr;\n}\ngeo $allowed_ip {\n default no;\n 192.168.1.0/24 yes;\n}\n \nmap $geoip2_data_country_code $allowed_country {\n default $allowed_ip;\n FR yes;\n}\nlog_format proxy_geo escape=json '"'"'[$time_local] [Client $remote_addr] [$allowed_country $geoip2_data_country_code $geoip2_data_country_name $geoip2_data_region_name $geoip2_data_city_name] "$http_user_agent" '"'"'\n                                 '"'"'$upstream_cache_status $upstream_status $status - $request_method $scheme $host "$request_uri" [Length $body_bytes_sent] [Gzip $gzip_ratio] [Sent-to $server] "$http_referer"'"'"';' > /data/nginx/custom/http_top.conf
